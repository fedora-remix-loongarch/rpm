From d220e0063e836ba14806c7efb2a85d1be04cd673 Mon Sep 17 00:00:00 2001
Message-Id: <d220e0063e836ba14806c7efb2a85d1be04cd673.1650979848.git.pmatilai@redhat.com>
From: Panu Matilainen <pmatilai@redhat.com>
Date: Tue, 26 Apr 2022 16:27:10 +0300
Subject: [PATCH] Fix regression on dynamic buildrequires with -ba --nodeps
 (RhBug:2078744)

---
 rpmbuild.c | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

diff --git a/rpmbuild.c b/rpmbuild.c
index da3810f75..377d672a7 100644
--- a/rpmbuild.c
+++ b/rpmbuild.c
@@ -673,9 +673,10 @@ int main(int argc, char *argv[])
 	/* fallthrough */
     case 'd':
 	ba->buildAmount |= RPMBUILD_BUILDREQUIRES;
-	ba->buildAmount |= RPMBUILD_DUMPBUILDREQUIRES;
-	if (!noDeps)
+	if ((buildChar == 'd' || buildChar == 'r') || noDeps == 0) {
+	    ba->buildAmount |= RPMBUILD_DUMPBUILDREQUIRES;
 	    ba->buildAmount |= RPMBUILD_CHECKBUILDREQUIRES;
+	}
 	if ((buildChar == 'r' || buildChar == 'd') && shortCircuit)
 	    break;
 	/* fallthrough */
-- 
2.35.1

